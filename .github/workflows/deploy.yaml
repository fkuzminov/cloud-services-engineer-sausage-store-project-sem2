name: Sausage Store Deploy

on:
  push:
    branches:
      - main

env:
  NEXUS_HELM_REPO: ${{ secrets.NEXUS_HELM_REPO }}
  NEXUS_HELM_REPO_USER: ${{ secrets.NEXUS_HELM_REPO_USER }}
  NEXUS_HELM_REPO_PASSWORD: ${{ secrets.NEXUS_HELM_REPO_PASSWORD }}
  SAUSAGE_STORE_NAMESPACE: ${{ secrets.SAUSAGE_STORE_NAMESPACE }}
  KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
  VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
  DOCKERHUB: ${{ secrets.DOCKERHUB }}
  DOCKER_USER: ${{ secrets.DOCKER_USER }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
#  build_and_push_to_docker_hub:
#      name: Push Docker image to DockerHub
#      runs-on: ubuntu-latest
#      steps:
#        - name: Check out the repo
#          uses: actions/checkout@v3
#        - name: Set up Docker Buildx
#          uses: docker/setup-buildx-action@v2
#        - name: Login to Docker
#          uses: docker/login-action@v2
#          with:
#            username: ${{ env.DOCKER_USER }}
#            password: ${{ env.DOCKER_PASSWORD }}
#
#        - name: Push Backend to DockerHub
#          uses: docker/build-push-action@v4
#          with:
#            context: ./backend/
#            push: true
#            tags: ${{ env.DOCKERHUB }}/sausage-backend:latest
#            build-args: |
#              VERSION=${{ github.sha }}
#
#        - name: Push Frontend to DockerHub
#          uses: docker/build-push-action@v4
#          with:
#            context: ./frontend/
#            push: true
#            tags: ${{ env.DOCKERHUB }}/sausage-frontend:latest
#
#        - name: Push Backend-report to DockerHub
#          uses: docker/build-push-action@v4
#          with:
#            context: ./backend-report/
#            push: true
#            tags: ${{ env.DOCKERHUB }}/sausage-backend-report:latest

  add_helm_chart_to_nexus:
      name: Add Helm Chart To Nexus
      runs-on: ubuntu-latest
      needs: build_and_push_to_docker_hub
      outputs:
        chart_version: ${{ steps.set_version.outputs.NEW_VERSION }}

      steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Helm and plugins
        uses: azure/setup-helm@v3
        with:
          version: '3.15.4'

      - name: Install helm-push plugin
        run: |
          helm plugin install https://github.com/chartmuseum/helm-push

      - name: Configure Nexus repository
        run: |
          helm repo add chartmuseum "${{ env.NEXUS_HELM_REPO }}" \
            --username="${{ env.NEXUS_HELM_REPO_USER }}" \
            --password="${{ env.NEXUS_HELM_REPO_PASSWORD }}"
          helm repo update

      - name: Prepare chart
        run: |
          cd sausage-store-chart
          helm dependency update
          helm lint .

      - name: Determine chart version
        id: set_version
        run: |
          LATEST_VER=$(helm search repo chartmuseum/sausage-store --versions --output json | jq -r '.[0].version // "0.1.0"' 2>/dev/null)
          if [ -z "$LATEST_VER" ] || [ "$LATEST_VER" = "null" ]; then
            LATEST_VER="0.1.0"
          fi
          export NEW_VER=$(echo "$LATEST_VER" | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "Last version in Nexus: $LATEST_VER â†’ New version: $NEW_VER"
          
          echo "NEW_VERSION=$NEW_VER" >> $GITHUB_OUTPUT

      - name: Push chart to Nexus
        run: |
          cd sausage-store-chart
          helm cm-push --version="${{ steps.set_version.outputs.NEW_VERSION }}" --context-path="/repository/aloeinwrath" . chartmuseum
          echo "Chart version ${{ steps.set_version.outputs.NEW_VERSION }} pushed to Nexus"
